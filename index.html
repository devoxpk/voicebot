<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lip Sync with Rhubarb WASM</title>
  <style>
    #avatar { width: 200px; }
  </style>
</head>
<body>
  <h2>Lip‑Sync Demo (Client‑Side WASM)</h2>
  <input type="file" id="audioInput" accept="audio/*"><br>
  <input type="file" id="imgInput" accept="image/png"><br>
  <button id="processBtn">Process & Animate</button><br>
  <audio id="player" controls></audio><br>
  <canvas id="avatar"></canvas>

  <script type="module">
    import { Rhubarb } from "rhubarb-lip-sync-wasm";

    const audioInput = document.getElementById("audioInput");
    const imgInput = document.getElementById("imgInput");
    const btn = document.getElementById("processBtn");
    const player = document.getElementById("player");
    const canvas = document.getElementById("avatar");
    const ctx = canvas.getContext("2d");

    let imgSheet;

    imgInput.addEventListener("change", e => {
      const file = e.target.files[0];
      const img = new Image();
      img.onload = () => {
        imgSheet = img;
        canvas.width = img.width / 8; // assuming 8 mouth frames
        canvas.height = img.height;
      };
      img.src = URL.createObjectURL(file);
    });

    btn.addEventListener("click", async () => {
      const audioFile = audioInput.files[0];
      if (!audioFile || !imgSheet) return alert("Upload audio and image first!");

      // Load audio
      const buf = await audioFile.arrayBuffer();
      const audioCtx = new AudioContext();
      const audioBuffer = await audioCtx.decodeAudioData(buf);

      // Play audio
      const blob = new Blob([buf], { type: audioFile.type });
      player.src = URL.createObjectURL(blob);
      player.play();

      // Analyze with Rhubarb WASM
      const rh = await Rhubarb.create();
      const result = await rh.getLipSync(audioBuffer);
      const cues = result.mouthCues;

      // Animate
      let startTime = audioCtx.currentTime;
      function render() {
        const t = audioCtx.currentTime - startTime;
        const cue = cues.find(c => t >= c.start && t < c.end);
        const frame = cue ? cue.value.charCodeAt(0) - 65 : 0;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(
          imgSheet,
          frame * canvas.width, 0,
          canvas.width, canvas.height,
          0, 0, canvas.width, canvas.height
        );

        if (t < audioBuffer.duration) requestAnimationFrame(render);
      }
      requestAnimationFrame(render);
    });
  </script>
</body>
</html>
